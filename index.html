<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WoTrack · Workout Progress Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA bits -->
  <meta name="theme-color" content="#020617">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="WoTrack">

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 0.9rem 1.1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.98);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(56,189,248,0.9);
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    main {
      flex: 1;
      padding: 0.9rem;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 0.85rem;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
        padding: 0.7rem;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), rgba(15,23,42,1));
      border-radius: var(--radius);
      border: 1px solid rgba(148,163,184,0.18);
      padding: 0.9rem 0.95rem;
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .badge {
      font-size: 0.7rem;
      color: var(--accent);
      background: rgba(56,189,248,0.08);
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.4);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .helper {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    label {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 0.15rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.42rem 0.5rem;
      border-radius: 11px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.97);
      color: var(--text);
      font-size: 0.88rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(56,189,248,0.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
      background: #020617;
    }

    textarea {
      resize: vertical;
      min-height: 48px;
      max-height: 110px;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.7);
      background: linear-gradient(to right, #0ea5e9, #22d3ee);
      color: #0b1120;
      padding: 0.45rem 0.85rem;
      font-size: 0.82rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 8px 22px rgba(8,47,73,0.8);
    }

    button.secondary {
      background: rgba(15,23,42,1);
      color: var(--text-muted);
      border-color: rgba(75,85,99,0.9);
      box-shadow: none;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1 1 140px;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      margin-top: 0.4rem;
    }

    .stat {
      flex: 1 1 120px;
      padding: 0.45rem 0.55rem;
      border-radius: 11px;
      border: 1px solid rgba(31,41,55,0.95);
      background: rgba(15,23,42,0.9);
      font-size: 0.78rem;
    }

    .stat-label {
      font-size: 0.74rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 0.05rem;
    }

    .stat-sub {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 0.05rem;
    }

    .positive { color: #4ade80; }
    .negative { color: var(--danger); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 0.3rem;
    }

    th, td {
      text-align: left;
      padding: 0.28rem 0.25rem;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }

    th {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tr:last-child td { border-bottom: none; }

    .text-center { text-align: center; }
    .text-right { text-align: right; }

    .muted { font-size: 0.76rem; color: var(--text-muted); }

    .danger-link {
      color: var(--danger);
      font-size: 0.74rem;
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    .scroll {
      max-height: 240px;
      overflow: auto;
      padding-right: 0.1rem;
    }

    canvas {
      width: 100%;
      max-width: 100%;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      display: block;
    }

    /* Weekly plan overlay */
    #scheduleOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.98);
      display: none;
      flex-direction: column;
      z-index: 30;
    }

    #scheduleOverlay.active {
      display: flex;
    }

    #scheduleOverlayHeader {
      padding: 0.9rem 1.1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #scheduleOverlayHeader h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    #scheduleOverlayBody {
      padding: 0.9rem 1.1rem 1.1rem;
      overflow: auto;
      flex: 1;
    }

    .today-row {
      background: rgba(56,189,248,0.06);
    }

    .chip {
      display: inline-flex;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      background: rgba(15,23,42,1);
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      header h1 { font-size: 1rem; }
      .subtitle { display: none; }
      .card { padding: 0.8rem; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>
      <span class="logo-dot"></span>
      WoTrack
    </h1>
    <div class="subtitle">Log workouts · Track 1RM · Bodyweight · Graphs · Schedule</div>
  </div>
</header>

<main>
  <!-- LEFT: logging -->
  <section class="card">
    <h2>Log Workout <span class="badge">Training</span></h2>
    <p class="helper">Add an exercise once, then log sets with date, reps, and weight. 1-rep max and volume are calculated automatically.</p>

    <div class="row" style="margin-bottom:0.6rem;">
      <div>
        <label for="exerciseName">New exercise</label>
        <input id="exerciseName" placeholder="e.g. Flat Bench Press">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="addExerciseBtn" type="button">+ Add exercise</button>
      </div>
    </div>

    <div style="margin-bottom:0.6rem;">
      <label for="exerciseSelect">Exercise</label>
      <select id="exerciseSelect"></select>
    </div>

    <div class="row" style="margin-bottom:0.4rem;">
      <div>
        <label for="workoutDate">Date</label>
        <input id="workoutDate" type="date">
      </div>
      <div>
        <label for="sets">Sets</label>
        <input id="sets" type="number" min="1" step="1" placeholder="3">
      </div>
    </div>

    <div class="row" style="margin-bottom:0.4rem;">
      <div>
        <label for="reps">Reps per set</label>
        <input id="reps" type="number" min="1" step="1" placeholder="8">
      </div>
      <div>
        <label for="weight">Weight (lbs or kg)</label>
        <input id="weight" type="number" min="0" step="0.5" placeholder="135">
      </div>
    </div>

    <div style="margin-bottom:0.4rem;">
      <label for="notes">Notes (optional)</label>
      <textarea id="notes" placeholder="RPE, form notes, etc."></textarea>
    </div>

    <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:0.8rem;">
      <div>
        <button id="addLogBtn" type="button">Save set</button>
      </div>
      <div class="muted">
        Est. set volume: <span id="volumePreview">0</span> · Est. 1RM: <span id="oneRMPreview">0</span>
      </div>
    </div>

    <hr style="border-color:rgba(31,41,55,0.9); margin:0.7rem 0;">

    <h2>Bodyweight <span class="badge">Tracking</span></h2>
    <p class="helper">Track your bodyweight to line up with strength and volume trends.</p>

    <div class="row" style="margin-bottom:0.4rem;">
      <div>
        <label for="bwDate">Date</label>
        <input id="bwDate" type="date">
      </div>
      <div>
        <label for="bwWeight">Bodyweight</label>
        <input id="bwWeight" type="number" min="0" step="0.1" placeholder="e.g. 190">
      </div>
    </div>

    <div class="row" style="align-items:center; justify-content:space-between;">
      <button id="addBwBtn" type="button">Save bodyweight</button>
      <span class="muted">Last entry: <span id="bwLatest">—</span></span>
    </div>

    <div class="scroll" style="margin-top:0.5rem; max-height:120px;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th class="text-right">Weight</th>
          </tr>
        </thead>
        <tbody id="bodyweightList"></tbody>
      </table>
    </div>

    <div style="margin-top:0.6rem; display:flex; justify-content:space-between; align-items:center; gap:0.4rem; flex-wrap:wrap;">
      <span class="muted">Data is stored only in this browser using localStorage.</span>
      <span id="clearAllBtn" class="danger-link">Reset all data</span>
    </div>
  </section>

  <!-- RIGHT: analytics, graphs, schedule snippet -->
  <section class="card">
    <h2>Overall Progress <span class="badge">Analytics</span></h2>

    <div class="stats-row">
      <div class="stat">
        <div class="stat-label">Training Days</div>
        <div class="stat-value" id="totalWorkouts">0</div>
        <div class="stat-sub">Unique days with any sets</div>
      </div>
      <div class="stat">
        <div class="stat-label">Total Volume</div>
        <div class="stat-value" id="totalVolume">0</div>
        <div class="stat-sub">Sum of sets × reps × weight</div>
      </div>
      <div class="stat">
        <div class="stat-label">Last 7 days volume</div>
        <div class="stat-value" id="last7Volume">0</div>
        <div class="stat-sub" id="last7Change">No data yet</div>
      </div>
      <div class="stat">
        <div class="stat-label">Bodyweight trend</div>
        <div class="stat-value" id="bwTrend">—</div>
        <div class="stat-sub" id="bwTrendDetail">Not enough data</div>
      </div>
    </div>

    <hr style="border-color:rgba(31,41,55,0.9); margin:0.7rem 0;">

    <h2>Graphs <span class="badge">Last ~30 entries</span></h2>

    <div style="margin-bottom:0.6rem;">
      <div class="muted" style="margin-bottom:0.2rem;">Daily training volume</div>
      <canvas id="volumeGraph" width="420" height="150"></canvas>
    </div>

    <div style="margin-bottom:0.6rem;">
      <div class="muted" style="margin-bottom:0.2rem;">Bodyweight trend</div>
      <canvas id="bodyweightGraph" width="420" height="150"></canvas>
    </div>

    <hr style="border-color:rgba(31,41,55,0.9); margin:0.7rem 0;">

    <!-- Per-Exercise 1RM panel removed -->

    <hr style="border-color:rgba(31,41,55,0.9); margin:0.7rem 0;">

    <h2>Schedule <span class="badge">Today</span></h2>
    <p class="helper">Today’s plan from your weekly schedule.</p>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem; flex-wrap:wrap;">
      <div id="todayScheduleSummary" class="muted">
        No plan set for today yet.
      </div>
      <button id="openScheduleBtn" type="button">Plan</button>
    </div>

    <hr style="border-color:rgba(31,41,55,0.9); margin:0.7rem 0;">

    <h2>Recent Sets <span class="badge">History</span></h2>
    <div class="scroll" style="max-height:150px;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Exercise</th>
            <th class="text-center">Sets</th>
            <th class="text-center">Reps</th>
            <th class="text-center">Weight</th>
            <th class="text-center">Est. 1RM</th>
            <th class="text-right">Volume</th>
          </tr>
        </thead>
        <tbody id="recentLogsBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- WEEKLY PLAN OVERLAY -->
<div id="scheduleOverlay">
  <div id="scheduleOverlayHeader">
    <h2>
      <span class="logo-dot"></span>
      Weekly Plan
    </h2>
    <button id="closeScheduleBtn" type="button" class="secondary">Close</button>
  </div>
  <div id="scheduleOverlayBody">
    <p class="helper">Edit your weekly plan. One plan per day, shown on the home screen for today.</p>

    <h3 style="font-size:0.9rem; margin-top:0.2rem;">Edit day</h3>
    <div class="row" style="margin-bottom:0.4rem; margin-top:0.25rem;">
      <div>
        <label for="scheduleDay">Day</label>
        <select id="scheduleDay">
          <option value="0">Sunday</option>
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>
      </div>
      <div>
        <label for="scheduleTitle">Plan</label>
        <input id="scheduleTitle" placeholder="e.g. Push / Chest & Tris, Rest">
      </div>
    </div>

    <div style="margin-bottom:0.4rem;">
      <label for="scheduleNotes">Notes (optional)</label>
      <textarea id="scheduleNotes" placeholder="e.g. Heavy bench focus, accessories, cardio, etc."></textarea>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:0.4rem; margin-bottom:0.8rem;">
      <button id="addScheduleBtn" type="button">Save day plan</button>
      <span class="muted">Saving replaces that day's plan.</span>
    </div>

    <h3 style="font-size:0.9rem; margin-top:0.1rem;">Full week</h3>
    <p class="helper">Week starts on today for easier planning.</p>

    <div class="scroll" style="max-height:260px;">
      <table>
        <thead>
          <tr>
            <th>Day</th>
            <th>Plan</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'workoutTracker_full_v3';

  let state = { exercises: [], logs: [], bodyweights: [], schedule: [] };

  function computeVolume(sets, reps, weight) {
    const s = Number(sets) || 0;
    const r = Number(reps) || 0;
    const w = Number(weight) || 0;
    return s * r * w;
  }

  function computeOneRM(weight, reps) {
    const w = Number(weight) || 0;
    const r = Number(reps) || 0;
    if (!w || !r) return 0;
    return w * (1 + r / 30);
  }

  function getTodayISO() {
    const d = new Date();
    const offset = d.getTimezoneOffset();
    const local = new Date(d.getTime() - offset * 60000);
    return local.toISOString().split('T')[0];
  }

  function getTodayDayIndex() {
    return new Date().getDay(); // 0 = Sun ... 6 = Sat
  }

  function parseLocalDate(iso) {
    if (!iso) return null;
    const parts = iso.split('-').map(Number);
    if (parts.length !== 3) return null;
    const [y, m, d] = parts;
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
  }

  function formatDate(iso) {
    if (!iso) return '';
    const d = parseLocalDate(iso);
    if (!d || isNaN(d)) return iso;
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      state.exercises = parsed.exercises || [];
      state.logs = parsed.logs || [];
      state.bodyweights = parsed.bodyweights || [];
      state.schedule = parsed.schedule || [];
      state.logs.forEach(l => {
        if (!l.volume) l.volume = computeVolume(l.sets, l.reps, l.weight);
        if (l.oneRM == null) l.oneRM = computeOneRM(l.weight, l.reps);
      });
    } catch (e) {
      console.error('Failed to load state', e);
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  const exerciseNameInput = document.getElementById('exerciseName');
  const exerciseSelect = document.getElementById('exerciseSelect');
  const workoutDateInput = document.getElementById('workoutDate');
  const setsInput = document.getElementById('sets');
  const repsInput = document.getElementById('reps');
  const weightInput = document.getElementById('weight');
  const notesInput = document.getElementById('notes');

  const addExerciseBtn = document.getElementById('addExerciseBtn');
  const addLogBtn = document.getElementById('addLogBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');

  const volumePreviewSpan = document.getElementById('volumePreview');
  const oneRMPreviewSpan = document.getElementById('oneRMPreview');

  const bwDateInput = document.getElementById('bwDate');
  const bwWeightInput = document.getElementById('bwWeight');
  const addBwBtn = document.getElementById('addBwBtn');
  const bwLatestSpan = document.getElementById('bwLatest');
  const bodyweightListBody = document.getElementById('bodyweightList');

  const totalWorkoutsEl = document.getElementById('totalWorkouts');
  const totalVolumeEl = document.getElementById('totalVolume');
  const last7VolumeEl = document.getElementById('last7Volume');
  const last7ChangeEl = document.getElementById('last7Change');
  const bwTrendEl = document.getElementById('bwTrend');
  const bwTrendDetailEl = document.getElementById('bwTrendDetail');

  const recentLogsBody = document.getElementById('recentLogsBody');

  // schedule DOM
  const scheduleDaySelect = document.getElementById('scheduleDay');
  const scheduleTitleInput = document.getElementById('scheduleTitle');
  const scheduleNotesInput = document.getElementById('scheduleNotes');
  const addScheduleBtn = document.getElementById('addScheduleBtn');
  const scheduleBody = document.getElementById('scheduleBody');
  const todayScheduleSummary = document.getElementById('todayScheduleSummary');
  const openScheduleBtn = document.getElementById('openScheduleBtn');
  const scheduleOverlay = document.getElementById('scheduleOverlay');
  const closeScheduleBtn = document.getElementById('closeScheduleBtn');

  const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

  function getLastLogForExercise(name) {
    if (!name) return null;
    const logs = state.logs.filter(l => l.exercise === name);
    if (!logs.length) return null;
    return logs.reduce((best, l) => {
      const dBest = best.date ? parseLocalDate(best.date) : new Date(0);
      const dCurr = l.date ? parseLocalDate(l.date) : new Date(0);
      if (dCurr > dBest) return l;
      if (dCurr < dBest) return best;
      const cBest = best.createdAt || 0;
      const cCurr = l.createdAt || 0;
      return cCurr > cBest ? l : best;
    });
  }

  function populateLastLogForSelectedExercise() {
    if (exerciseSelect.disabled || !exerciseSelect.value) return;
    const last = getLastLogForExercise(exerciseSelect.value);
    if (!last) {
      setsInput.value = '';
      repsInput.value = '';
      weightInput.value = '';
      renderVolumePreview();
      return;
    }
    setsInput.value = last.sets ?? '';
    repsInput.value = last.reps ?? '';
    weightInput.value = last.weight ?? '';
    renderVolumePreview();
  }

  function renderExerciseSelect() {
    exerciseSelect.innerHTML = '';
    if (!state.exercises.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Add an exercise above first';
      exerciseSelect.appendChild(opt);
      exerciseSelect.disabled = true;
      return;
    }
    exerciseSelect.disabled = false;
    state.exercises.slice().sort((a, b) => a.localeCompare(b)).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      exerciseSelect.appendChild(opt);
    });
  }

  function renderVolumePreview() {
    const v = computeVolume(setsInput.value, repsInput.value, weightInput.value);
    const one = computeOneRM(weightInput.value, repsInput.value);
    volumePreviewSpan.textContent = Math.round(v) || 0;
    oneRMPreviewSpan.textContent = one ? Math.round(one) : 0;
  }

  function renderOverallStats() {
    const logs = state.logs;
    if (!logs.length) {
      totalWorkoutsEl.textContent = '0';
      totalVolumeEl.textContent = '0';
      last7VolumeEl.textContent = '0';
      last7ChangeEl.textContent = 'Log some sets to see trends';
      last7ChangeEl.className = 'stat-sub';
      return;
    }

    const uniqueDays = new Set(logs.map(l => l.date));
    totalWorkoutsEl.textContent = String(uniqueDays.size);

    const totalVolume = logs.reduce((sum, l) => sum + (l.volume || 0), 0);
    totalVolumeEl.textContent = Math.round(totalVolume).toLocaleString();

    const now = new Date();
    const dayMs = 24 * 60 * 60 * 1000;
    const startCurrent = new Date(now.getTime() - 7 * dayMs);
    const startPrev = new Date(now.getTime() - 14 * dayMs);

    let current7 = 0;
    let prev7 = 0;
    logs.forEach(l => {
      if (!l.date) return;
      const d = parseLocalDate(l.date);
      if (isNaN(d)) return;
      if (d > startCurrent && d <= now) {
        current7 += l.volume || 0;
      } else if (d > startPrev && d <= startCurrent) {
        prev7 += l.volume || 0;
      }
    });

    last7VolumeEl.textContent = Math.round(current7).toLocaleString();

    if (!current7 && !prev7) {
      last7ChangeEl.textContent = 'Not enough history yet';
      last7ChangeEl.className = 'stat-sub';
    } else if (!prev7) {
      last7ChangeEl.textContent = 'First active week – nice start';
      last7ChangeEl.className = 'stat-sub positive';
    } else {
      const diff = current7 - prev7;
      const pct = (diff / prev7) * 100;
      if (diff >= 0) {
        last7ChangeEl.textContent = `Up ${Math.round(pct)}% vs previous week`;
        last7ChangeEl.className = 'stat-sub positive';
      } else {
        last7ChangeEl.textContent = `Down ${Math.abs(Math.round(pct))}% vs previous week`;
        last7ChangeEl.className = 'stat-sub negative';
      }
    }
  }

  function renderRecentLogs() {
    recentLogsBody.innerHTML = '';
    const logs = state.logs
      .slice()
      .sort((a, b) => new Date(b.date) - new Date(a.date) || (b.createdAt || 0) - (a.createdAt || 0))
      .slice(0, 40);

    logs.forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(l.date)}</td>
        <td>${l.exercise || ''}</td>
        <td class="text-center">${l.sets}</td>
        <td class="text-center">${l.reps}</td>
        <td class="text-center">${l.weight}</td>
        <td class="text-center">${l.oneRM ? Math.round(l.oneRM) : '—'}</td>
        <td class="text-right">${Math.round(l.volume || 0).toLocaleString()}</td>
      `;
      recentLogsBody.appendChild(tr);
    });
  }

  function renderBodyweight() {
    const bws = state.bodyweights.slice().sort((a, b) => parseLocalDate(a.date) - parseLocalDate(b.date));
    bodyweightListBody.innerHTML = '';
    if (!bws.length) {
      bwLatestSpan.textContent = '—';
      bwTrendEl.textContent = '—';
      bwTrendDetailEl.textContent = 'Not enough data';
      return;
    }

    const latest = bws[bws.length - 1];
    bwLatestSpan.textContent = `${latest.weight} (${formatDate(latest.date)})`;

    bws.slice().reverse().slice(0, 15).forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(entry.date)}</td>
        <td class="text-right">${entry.weight}</td>
      `;
      bodyweightListBody.appendChild(tr);
    });

    const now = new Date();
    const dayMs = 24 * 60 * 60 * 1000;
    const startCurrent = new Date(now.getTime() - 7 * dayMs);
    const startPrev = new Date(now.getTime() - 14 * dayMs);

    let currentVals = [];
    let prevVals = [];

    bws.forEach(bw => {
      const d = parseLocalDate(bw.date);
      if (isNaN(d)) return;
      if (d > startCurrent && d <= now) {
        currentVals.push(Number(bw.weight) || 0);
      } else if (d > startPrev && d <= startCurrent) {
        prevVals.push(Number(bw.weight) || 0);
      }
    });

    const avg = arr => arr.length ? arr.reduce((a, v) => a + v, 0) / arr.length : 0;

    const avgCurrent = avg(currentVals);
    const avgPrev = avg(prevVals);

    if (!avgCurrent && !avgPrev) {
      bwTrendEl.textContent = latest.weight;
      bwTrendDetailEl.textContent = 'Need a couple of weeks of data';
      bwTrendDetailEl.className = 'stat-sub';
    } else if (!avgPrev) {
      bwTrendEl.textContent = latest.weight;
      bwTrendDetailEl.textContent = 'First week tracked';
      bwTrendDetailEl.className = 'stat-sub';
    } else {
      const diff = avgCurrent - avgPrev;
      const dir = diff > 0 ? 'up' : 'down';
      const absDiff = Math.abs(diff).toFixed(1);
      bwTrendEl.textContent = latest.weight;
      bwTrendDetailEl.textContent = `${dir} ~${absDiff} vs previous week avg`;
      bwTrendDetailEl.className = 'stat-sub ' + (diff <= 0 ? 'positive' : 'negative');
    }
  }

  function drawLineGraph(canvasId, values) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !canvas.getContext) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;

    ctx.clearRect(0, 0, w, h);

    if (!values || !values.length) {
      ctx.fillStyle = 'rgba(148,163,184,0.7)';
      ctx.font = '12px system-ui';
      ctx.fillText('No data yet', 10, h / 2);
      return;
    }

    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;
    const padding = 14;
    const innerW = w - padding * 2;
    const innerH = h - padding * 2;

    ctx.strokeStyle = 'rgba(31,41,55,0.9)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, h - padding);
    ctx.lineTo(w - padding, h - padding);
    ctx.stroke();

    ctx.strokeStyle = '#38bdf8';
    ctx.lineWidth = 2;
    ctx.beginPath();

    values.forEach((v, i) => {
      const x = padding + (values.length === 1 ? innerW / 2 : (innerW * i / (values.length - 1)));
      const y = padding + innerH - ((v - min) / range) * innerH;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();
  }

  function renderGraphs() {
    const volumeByDate = {};
    state.logs.forEach(l => {
      if (!l.date) return;
      volumeByDate[l.date] = (volumeByDate[l.date] || 0) + (l.volume || 0);
    });
    const volumeDates = Object.keys(volumeByDate).sort();
    const recentVolumeDates = volumeDates.slice(-30);
    const volumeValues = recentVolumeDates.map(d => volumeByDate[d]);
    drawLineGraph('volumeGraph', volumeValues);

    const sortedBw = state.bodyweights.slice().sort((a, b) => parseLocalDate(a.date) - parseLocalDate(b.date));
    const recentBw = sortedBw.slice(-30);
    const bwValues = recentBw.map(b => Number(b.weight) || 0);
    drawLineGraph('bodyweightGraph', bwValues);
  }

  // --- schedule helpers/render ---

  function upsertScheduleEntry(dayIndex, title, notes) {
    const d = Number(dayIndex);
    const t = (title || '').trim() || 'Rest';
    const n = (notes || '').trim();
    const existingIndex = state.schedule.findIndex(e => e.day === d);
    const entry = { day: d, title: t, notes: n, updatedAt: Date.now() };
    if (existingIndex >= 0) state.schedule[existingIndex] = entry;
    else state.schedule.push(entry);
  }

  function renderSchedule() {
    scheduleBody.innerHTML = '';
    const todayIdx = getTodayDayIndex();

    // Rotate week so it starts on today
    const order = [];
    for (let i = 0; i < 7; i++) {
      order.push((todayIdx + i) % 7);
    }

    order.forEach(idx => {
      const entry = state.schedule.find(e => e.day === idx);
      const tr = document.createElement('tr');
      if (idx === todayIdx) tr.classList.add('today-row');
      tr.innerHTML = `
        <td>${dayNames[idx]}${idx === todayIdx ? ' (today)' : ''}</td>
        <td>${entry ? entry.title : '—'}</td>
        <td>${entry && entry.notes ? entry.notes : ''}</td>
      `;
      scheduleBody.appendChild(tr);
    });

    // Update today's summary on home
    const todayEntry = state.schedule.find(e => e.day === todayIdx);
    if (todayEntry) {
      todayScheduleSummary.textContent =
        `${dayNames[todayIdx]}: ${todayEntry.title}` +
        (todayEntry.notes ? ` — ${todayEntry.notes}` : '');
    } else {
      todayScheduleSummary.textContent = 'No plan set for today yet.';
    }

    // Default select to today if not set
    scheduleDaySelect.value = String(todayIdx);
  }

  // Event handlers
  addExerciseBtn.addEventListener('click', () => {
    const name = exerciseNameInput.value.trim();
    if (!name) return alert('Enter a name for the exercise.');
    if (!state.exercises.includes(name)) {
      state.exercises.push(name);
      saveState();
      renderExerciseSelect();
      exerciseSelect.value = name;
    }
    exerciseNameInput.value = '';
    populateLastLogForSelectedExercise();
  });

  addLogBtn.addEventListener('click', () => {
    if (exerciseSelect.disabled || !exerciseSelect.value) {
      return alert('Add/select an exercise first.');
    }
    const exercise = exerciseSelect.value;
    const date = workoutDateInput.value || getTodayISO();
    const sets = Number(setsInput.value || 0);
    const reps = Number(repsInput.value || 0);
    const weight = Number(weightInput.value || 0);
    const notes = (notesInput.value || '').trim();

    if (!sets || !reps || !weight) {
      if (!confirm('Sets, reps, or weight are empty/zero. Save anyway?')) return;
    }

    const volume = computeVolume(sets, reps, weight);
    const oneRM = computeOneRM(weight, reps);

    state.logs.push({
      id: Date.now().toString(36),
      exercise,
      date,
      sets,
      reps,
      weight,
      volume,
      oneRM,
      notes,
      createdAt: Date.now()
    });

    saveState();

    setsInput.value = '';
    repsInput.value = '';
    weightInput.value = '';
    notesInput.value = '';
    workoutDateInput.value = date;

    renderVolumePreview();
    renderOverallStats();
    renderRecentLogs();
    renderGraphs();
  });

  addBwBtn.addEventListener('click', () => {
    const date = bwDateInput.value || getTodayISO();
    const weight = Number(bwWeightInput.value || 0);
    if (!weight) return alert('Enter a bodyweight.');

    state.bodyweights.push({
      id: Date.now().toString(36),
      date,
      weight,
      createdAt: Date.now()
    });

    saveState();

    bwWeightInput.value = '';
    bwDateInput.value = date;

    renderBodyweight();
    renderGraphs();
  });

  clearAllBtn.addEventListener('click', () => {
    if (!confirm('This will delete ALL exercises, sets, bodyweights, and schedule stored in this browser. Continue?')) return;
    state = { exercises: [], logs: [], bodyweights: [], schedule: [] };
    saveState();
    renderExerciseSelect();
    renderVolumePreview();
    renderOverallStats();
    renderRecentLogs();
    renderBodyweight();
    renderGraphs();
    renderSchedule();
  });

  exerciseSelect.addEventListener('change', () => {
    populateLastLogForSelectedExercise();
  });

  [setsInput, repsInput, weightInput].forEach(el => {
    el.addEventListener('input', renderVolumePreview);
  });

  addScheduleBtn.addEventListener('click', () => {
    const dayIndex = scheduleDaySelect.value;
    if (dayIndex === '' || dayIndex == null) return;
    const title = scheduleTitleInput.value;
    const notes = scheduleNotesInput.value;
    upsertScheduleEntry(dayIndex, title, notes);
    saveState();
    renderSchedule();
  });

  openScheduleBtn.addEventListener('click', () => {
    scheduleOverlay.classList.add('active');
  });

  closeScheduleBtn.addEventListener('click', () => {
    scheduleOverlay.classList.remove('active');
  });

  function init() {
    console.log('WoTrack loaded');
    loadState();
    workoutDateInput.value = getTodayISO();
    bwDateInput.value = getTodayISO();
    renderExerciseSelect();
    populateLastLogForSelectedExercise();
    renderVolumePreview();
    renderOverallStats();
    renderRecentLogs();
    renderBodyweight();
    renderGraphs();
    renderSchedule();
  }

  init();

  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('./service-worker.js')
        .catch(err => console.error('SW registration failed', err));
    });
  }
</script>

</body>
</html>
